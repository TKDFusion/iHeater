#========================================================
#=====================iHeater cfg========================
#========================================================

#========================================================
# MCU & PINS - LEFT HEATER
#========================================================
[mcu iHeater_left]
serial: # add your ID e.g. /dev/serial/by-id/usb-Klipper_stm32f042x6_1234567899ABCDEF0123458F-if00
restart_method: command

[board_pins iHeater_left_Aliases]
mcu: iHeater_left
aliases:
    TH0=PA3, TH1=PA0, TH2=PB1,
    HEATER=PA1, FAN=PA2,
    MODE=PA4,
    LED_HEATER_ON=PA7,   # Rightmost LED (Heating element)
    LED_TARGET_SET=PA6,  # Center LED (Target set)
    LED_FAN_ON=PA5,      # Leftmost LED (Fan active)
    USART1_TX=PA9, USART1_RX=PA10
    
#========================================================
# MCU & PINS - RIGHT HEATER
#========================================================
[mcu iHeater_right]
serial: # add your ID (different!) e.g. /dev/serial/by-id/usb-Klipper_stm32f042x6_22222-if00
restart_method: command

[board_pins iHeater_right_Aliases]
mcu: iHeater_right
aliases:
    TH0=PA3, TH1=PA0, TH2=PB1,
    HEATER=PA1, FAN=PA2,
    MODE=PA4,
    LED_HEATER_ON=PA7,   # Rightmost LED (Heating element)
    LED_TARGET_SET=PA6,  # Center LED (Target set)
    LED_FAN_ON=PA5,      # Leftmost LED (Fan active)
    USART1_TX=PA9, USART1_RX=PA10

#============================================================
#================== iHeater CONFIG - LEFT ===================
#============================================================

[heater_generic iHeater_left_H]
heater_pin: iHeater_left:HEATER
max_power: 1
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: iHeater_left:TH0
pwm_cycle_time: 0.3
min_temp: 0
max_temp: 120
control: pid
pid_Kp: 37.948
pid_Ki: 2.040
pid_Kd: 176.497

[verify_heater iHeater_left_H]
max_error: 120                
check_gain_time: 60           
hysteresis: 20               
heating_gain: 0.2 

[heater_fan chamber_heater_fan_left]
pin: iHeater_left:FAN
heater: iHeater_left_H
heater_temp: 50.0
fan_speed: 1.0
shutdown_speed: 0
kick_start_time: 0.5

[temperature_sensor iHeater_back_S]
sensor_pin: iHeater_left:TH1
sensor_type: NTC 100K MGB18-104F39050L32
min_temp: 0
max_temp: 140

# Define all LEDs as [output_pin] for macro control
[output_pin iHeater_L_Heater_On]
pin: iHeater_left:LED_HEATER_ON

[output_pin iHeater_L_Target_Set]
pin: iHeater_left:LED_TARGET_SET

[output_pin iHeater_L_Fan_On]
pin: iHeater_left:LED_FAN_ON

[gcode_button mode_button_left]
pin: iHeater_left:MODE
# debounce_delay: 50
press_gcode: iHEATER_OFF

#============================================================
#================== iHeater CONFIG - RIGHT ==================
#============================================================

[heater_generic iHeater_right_H]
heater_pin: iHeater_right:HEATER
max_power: 1
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: iHeater_right:TH0
pwm_cycle_time: 0.3
min_temp: 0
max_temp: 120
control: pid
pid_Kp: 37.948
pid_Ki: 2.040
pid_Kd: 176.497

[verify_heater iHeater_right_H]
max_error: 120                
check_gain_time: 60           
hysteresis: 20               
heating_gain: 0.2 

[heater_fan chamber_heater_fan_right]
pin: iHeater_right:FAN
heater: iHeater_right_H
heater_temp: 50.0
fan_speed: 1.0
shutdown_speed: 0
kick_start_time: 0.5

[temperature_sensor iHeater_gantry_S]
sensor_pin: iHeater_right:TH1
sensor_type: NTC 100K MGB18-104F39050L32
min_temp: 0
max_temp: 140

[gcode_button mode_button]
pin: iHeater_right:MODE
# debounce_delay: 50
press_gcode: iHEATER_OFF

# Define all LEDs as [output_pin] for macro control
[output_pin iHeater_R_Heater_On]
pin: iHeater_right:LED_HEATER_ON

[output_pin iHeater_R_Target_Set]
pin: iHeater_right:LED_TARGET_SET

[output_pin iHeater_R_Fan_On]
pin: iHeater_right:LED_FAN_ON


#######################################################
################## DUAL HEATER SETUP ##################
#######################################################

[temperature_sensor Chamber]
sensor_type: temperature_combined
sensor_list: temperature_sensor iHeater_gantry_S, temperature_sensor iHeater_gantry_S, temperature_sensor iHeater_back_S    # 2:1 weighted average
combination_method: mean
min_temp: 0
max_temp: 140
maximum_deviation: 20

[gcode_macro CHAMBER_VARS]
variable_chamber_target: 0
variable_bed_target: 0
variable_start_offset: 10
variable_delta_temp: 10
variable_min_heater_temp: 50
variable_max_heater_temp: 90
variable_control_interval: 1.0
variable_air_min_delta: 0.5
variable_air_max_delta: 5.0
variable_verify_ac_power_delay: 60  # grace period seconds
variable_min_heater_delta: 5        # heater temp needs to rise above chamber temp by this amount if power > 90% °C
variable_heat_start_time: 0         # Do not change
variable_ac_power_verified: False 
gcode:

#######################################################
#################### REVISED MACROS ###################
#######################################################

[gcode_macro M141]
gcode:
    {% set chamber_target = params.S|default(printer["gcode_macro CHAMBER_VARS"].chamber_target)|int %}
    {% set delta_temp = params.D|default(printer["gcode_macro CHAMBER_VARS"].delta_temp)|int %}
    {% set max_heater_temp = params.H|default(printer["gcode_macro CHAMBER_VARS"].max_heater_temp)|int %}
    {% set control_interval = printer["gcode_macro CHAMBER_VARS"].control_interval|float %}

    RESPOND prefix="M141" msg="S{chamber_target} D{delta_temp} H{max_heater_temp}"

    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=chamber_target VALUE={chamber_target}
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=delta_temp VALUE={delta_temp}
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=max_heater_temp VALUE={max_heater_temp}

    # Record the start time of the heating cycle for the AC power check
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=heat_start_time VALUE={printer.toolhead.estimated_print_time}
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=ac_power_verified VALUE=False

    # Turn on the "Target Set" LED (Center LED)
    SET_PIN PIN=iHeater_L_Target_Set VALUE=1
    SET_PIN PIN=iHeater_R_Target_Set VALUE=1

    iHEATER_CONTROL

[gcode_macro M191]
gcode:
    {% set chamber_target = params.S|default(printer["gcode_macro CHAMBER_VARS"].chamber_target)|int %}
    {% set delta_temp = params.D|default(printer["gcode_macro CHAMBER_VARS"].delta_temp)|int %}
    {% set max_heater_temp = params.H|default(printer["gcode_macro CHAMBER_VARS"].max_heater_temp)|int %}
    {% set start_offset = params.W|default(printer["gcode_macro CHAMBER_VARS"].start_offset)|int %}
    
    RESPOND prefix="M191" msg="S{chamber_target} D{delta_temp} H{max_heater_temp} W{start_offset}"

    M141 S{chamber_target} D{delta_temp} H{max_heater_temp}
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=start_offset VALUE={start_offset}

    # MODIFIED: Wait until BOTH chamber sensors reach the target temperature
    {% set min_temp_to_wait = chamber_target - start_offset %}
    RESPOND prefix="M191" msg="Waiting for chamber to reach {min_temp_to_wait}°C..."
    #TEMPERATURE_WAIT SENSOR="temperature_sensor iHeater_back_S" MINIMUM={min_temp_to_wait}
    #TEMPERATURE_WAIT SENSOR="temperature_sensor iHeater_gantry_S" MINIMUM={min_temp_to_wait}
    TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM={min_temp_to_wait}
    RESPOND prefix="M191" msg="Chamber reached {min_temp_to_wait}°C"

[gcode_macro iHEATER_ON]
description: Alternative to M141 & M191 with alternative parameter names
gcode:
    {% set s = params.CHAMBER_TEMP|default(0)|int %}
    {% set b = params.BED_TEMP|default(0)|int %}
    {% set d = params.DELTA|default(10)|int %}
    {% set h = params.HEATER_MAX|default(90)|int %}
    {% set w = params.CHAMBER_AWAIT_TEMP|default(10)|int %}

    {% if b > 0 and b<110 %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={b}
    {% endif %}

    {% if w > 0 %}
        M191 S{s} D{d} H{h} W{s - w}
    {% else %}
        M141 S{s} D{d} H{h}
    {% endif %}

[gcode_macro iHEATER_OFF]
gcode:
    # Set target temp to 0 and turn off heaters
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=chamber_target VALUE=0
    SET_HEATER_TEMPERATURE HEATER=iHeater_left_H TARGET=0
    SET_HEATER_TEMPERATURE HEATER=iHeater_right_H TARGET=0

     # Reset the AC verify timer
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=heat_start_time VALUE=0
    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=ac_power_verified VALUE=False

    # Immediately turn off ALL LEDs for a clean shutdown
    SET_PIN PIN=iHeater_L_Target_Set VALUE=0
    SET_PIN PIN=iHeater_R_Target_Set VALUE=0
    SET_PIN PIN=iHeater_L_Heater_On VALUE=0
    SET_PIN PIN=iHeater_R_Heater_On VALUE=0
    SET_PIN PIN=iHeater_L_Fan_On VALUE=0
    SET_PIN PIN=iHeater_R_Fan_On VALUE=0

    # Run one last cycle to handle cooldown
    UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION=1
    RESPOND prefix="iHeater_off" msg="Heating disabled for both heaters."

# In case warm heaters make them start at boot time 
[delayed_gcode _UPDATE_FAN_LEDS]
initial_duration: 5
gcode:
    SET_PIN PIN=iHeater_L_Fan_On VALUE={1 if printer['heater_fan chamber_heater_fan_left'].speed > 0 else 0}
    SET_PIN PIN=iHeater_R_Fan_On VALUE={1 if printer['heater_fan chamber_heater_fan_right'].speed > 0 else 0}

    {% if printer['heater_fan chamber_heater_fan_left'].speed + printer['heater_fan chamber_heater_fan_right'].speed > 0  %}
        UPDATE_DELAYED_GCODE ID=_UPDATE_FAN_LEDS DURATION=3
    {% endif %}

[gcode_macro _AC_POWER_FAULT]
gcode:
    {% set heater_list = params.HEATER_LIST|default("Unknown") %}
    # Turn off iHeaters
    iHEATER_OFF
    # Turn off the bed heater
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    # Halt the printer with a clear message
    { action_raise_error("Heater Fault: %s failed to heat. Check iHeater AC power." % heater_list) }

[gcode_macro iHEATER_CONTROL]
gcode:
    # --- 1. SET LEDs BASED ON CURRENT STATE ---
    # Heater LEDs (blinking)
    SET_PIN PIN=iHeater_L_Heater_On VALUE={1 if printer['heater_generic iHeater_left_H'].power > 0.3 else 0}
    SET_PIN PIN=iHeater_R_Heater_On VALUE={1 if printer['heater_generic iHeater_right_H'].power > 0.3 else 0}
    SET_PIN PIN=iHeater_L_Fan_On VALUE={1 if printer['heater_fan chamber_heater_fan_left'].speed > 0 else 0}
    SET_PIN PIN=iHeater_R_Fan_On VALUE={1 if printer['heater_fan chamber_heater_fan_right'].speed > 0 else 0}
    
    # --- 2. MAIN TEMPERATURE LOGIC ---
    {% set chamber_vars = printer["gcode_macro CHAMBER_VARS"] %}
    {% set target_chamber_temp = chamber_vars.chamber_target|float %}
    {% set control_interval = chamber_vars.control_interval|float %}
    {% set target_heater_temp = 0.0 %}

    {% if target_chamber_temp > 0 %}
        # --- HEATING STATE ---
        # Calculate the required heater temperature
        #{% set chamber_temp = (printer["temperature_sensor iHeater_back_S"].temperature + printer["temperature_sensor iHeater_gantry_S"].temperature) / 2.0 %}
        {% set chamber_temp = printer["temperature_sensor Chamber"].temperature %}
        {% set temp_diff = target_chamber_temp - chamber_temp %}
        {% set output_range = ([chamber_vars.delta_temp, chamber_vars.max_heater_temp - target_chamber_temp]|max) - chamber_vars.delta_temp %}
        {% set input_range = chamber_vars.air_max_delta - chamber_vars.air_min_delta %}
        {% set slope = output_range / input_range if input_range > 0 else 0 %}
        {% set clamped_input = ([chamber_vars.air_min_delta, temp_diff, chamber_vars.air_max_delta]|sort)[1] %}
        {% set adjustment = chamber_vars.delta_temp + slope * (clamped_input - chamber_vars.air_min_delta) %}
        {% set target_heater_temp = (target_chamber_temp + adjustment)|round(2) %}

        # --- AC POWER VERIFICATION ---
        {% if not chamber_vars.ac_power_verified %}
            {% set start_time = chamber_vars.heat_start_time|float %}
            {% set current_time = printer.toolhead.estimated_print_time|float %}
            {% set verify_delay = chamber_vars.verify_ac_power_delay|float %}
    
            {% if start_time > 0 and current_time > start_time + verify_delay %}
                # Create a list to hold the names of any faulty heaters
                {% set faulty_heaters = [] %}
    
                # Check Left Heater
                {% set lh_power = printer['heater_generic iHeater_left_H'].power %}
                {% set lh_temp = printer['heater_generic iHeater_left_H'].temperature %}
                {% set lc_temp = printer['temperature_sensor iHeater_back_S'].temperature %}
                {% if lh_power > 0.9 and lh_temp < lc_temp + chamber_vars.min_heater_delta %}
                    {% set faulty_heaters = faulty_heaters + ['Left iHeater'] %}
                {% endif %}
    
                # Check Right Heater
                {% set rh_power = printer['heater_generic iHeater_right_H'].power %}
                {% set rh_temp = printer['heater_generic iHeater_right_H'].temperature %}
                {% set rc_temp = printer['temperature_sensor iHeater_gantry_S'].temperature %}
                {% if rh_power > 0.9 and rh_temp < rc_temp + chamber_vars.min_heater_delta %}
                    {% set faulty_heaters = faulty_heaters + ['Left iHeater'] %}
                {% endif %}
    
                # If the list is not empty, join the names and trigger the fault
                {% if faulty_heaters|length > 0 %}
                    {% set heater_list = faulty_heaters|join(' and ') %}
                    _AC_POWER_FAULT HEATER_LIST="'%s'" % heater_list
                {% else %}
                    # If the check passed, set the flag to true to prevent it from running again.
                    SET_GCODE_VARIABLE MACRO=CHAMBER_VARS VARIABLE=ac_power_verified VALUE=True
                {% endif %}
            {% endif %}
        {% endif %}

    {% else %}
        # --- COOLING/IDLE STATE ---
        # If heaters are cool, turn off Target Set LED and stop the loop
        {% set min_heater_temp = chamber_vars.min_heater_temp|float %}
        {% if printer["heater_generic iHeater_left_H"].temperature < min_heater_temp and printer["heater_generic iHeater_right_H"].temperature < min_heater_temp %}
            RESPOND prefix="iHeater_control" msg="Heater cooldown complete."
            SET_PIN PIN=iHeater_L_Target_Set VALUE=0
            SET_PIN PIN=iHeater_R_Target_Set VALUE=0
            {% set control_interval = 0.0 %} # Stop the loop
            SET_PIN PIN=iHeater_L_Fan_On VALUE=0
            SET_PIN PIN=iHeater_R_Fan_On VALUE=0
        {% endif %}
    {% endif %}

    # Set heater temps for both heaters
    SET_HEATER_TEMPERATURE HEATER=iHeater_left_H TARGET={target_heater_temp}
    SET_HEATER_TEMPERATURE HEATER=iHeater_right_H TARGET={target_heater_temp}
    
    # Schedule the next run
    UPDATE_DELAYED_GCODE ID=_iHEATER_CONTROL DURATION={control_interval}


[delayed_gcode _iHEATER_CONTROL]
gcode:
    iHEATER_CONTROL
