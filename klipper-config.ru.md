
<!-- ## Установка -->
### Конфигурация iHeater для Klipper

Данный раздел содержит конфигурационные файлы для нагревателя камеры 3D-принтера iHeater на основе прошивки Klipper и одноименной платы управления. Конфигурация предназначена для управления нагревом камеры и вентиляторами с помощью микроконтроллера iHeater.

### Требования

#### Аппаратное обеспечение
  - Плата управления iHeater
  - Терморезисторы NTC 100K 3950 (2 шт.)
  - PTC нагревательный элемент 220В 100Вт, для камеры
  - Вентилятор 7530 220В, для циркуляции воздуха в камере
  - Термофьюз KSD9700 или аналогичный (220В 5А 130С)

#### Программное обеспечение
  - Klipper (последняя версия)
  - Настроенный и работающий хост с Klipper

## Конфигурация Klipper


Скопируйте конфигурационные файлы iHeater.cfg в папку с файлом printer.cfg(это может быть /klipper_config) и подключите его в printer.cfg с помощью директивы [include]


```
cd ~/klipper_config
```

```
wget https://raw.githubusercontent.com/pavluchenkor/iHeater/refs/heads/main/iHeater.cfg
```

Откройте printer.cfg и добавьте

    [include iHeater.cfg]

## Подключение MCU iHeater

Измените файл iHeater.cfg, укажите полученный ID

```
    [mcu iHeater]
    serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_ХХХХХХХХХХХХХХХХХХХХХХХ-ХХХХ

```

## Подготовка к использованию

Конфигурационный файл содержит секцию:

```ini
[gcode_macro CHAMBER_VARS]
variable_chamber_target: 0          # Целевая температура камеры, °C
variable_start_offset: 10           # Температура камеры, достаточная для начала печати, °C
variable_delta_temp: 10             # Разница между температурой камеры и нагревателя, °C
variable_min_heater_temp: 50        # Минимальная температура нагревателя (для охлаждения), °C
variable_max_heater_temp: 100       # Максимальная температура нагревателя, °C
variable_control_interval: 1.0      # Интервал вызова функции управления, секунды
variable_air_min_delta: 0.5         # Минимальная разница между целевой и текущей температурой камеры (нагреватель = целевая + delta_temp), °C
variable_air_max_delta: 5.0         # Максимальная разница между целевой и текущей температурой камеры (нагреватель = max_heater_temp), °C
gcode:
```

**Максимально допустимая температура нагревателя зависит от материала корпуса.**

Для проверки:

!. Включите нагрев стола 90-100°C
1. Установите температуру нагревателя на 100°C через интерфейс Fluidd или Mainsail.
2. Убедитесь, что iHeater находится внутри закрытого объема принтера.
3. После достижения установленной температуры проверьте участки, где нагреватель соприкасается с пластиковыми элементами корпуса. Пластик не должен размягчаться.
4. Увеличьте температуру на 5-10°C и повторите проверку.
5. Повторяйте, пока не будет достигнута максимально допустимая температура нагревателя без риска деформации корпуса.

Такой подход позволяет определить безопасный температурный максимум и достичь наилучшей эффективности работы iHeater.


## Использование

### Команды управления нагревом камеры
- Установка температуры камеры:
 

        M141 S60  ; Устанавливает температуру камеры на 60°C

- Ожидание достижения температуры:

        M191 S60  ; Ждет, пока температура камеры достигнет 60°C

- Остановка нагрева камеры:

        iHEATER_OFF   ; Отключает нагрев камеры

- В завершении G-кода слайсера добавьте `iHEATER_OFF`, чтобы корректно отключить нагрев камеры.

### Стартовый g-code

Современные слайсеры поддерживают автоматическое включение активной термокамеры при формировании g-code печати. Для этого, в свойствах филамента необходимо указать температуру камеры. В случае если слайсер не обладает этим функционалом, в стартовый g-code необходимо добавить команду включения нагрева активной термокамеры.

Порядок действий:

- Установить целевую температуру камеры
- Включить нагрев стола для эффективного и быстрого нагрева камеры 
- Продолжить стандартный стартовый G-code печати

Пример стартового g-code
```
; --- Начало стартового G-code ---

; ****** Старт iHeater ******
M141 S60       ; Установить температуру камеры на 60°C
; ****** Конец блока iHeater ******

; --- Остальной стартовый g-code ---
; Включение нагрева стола
...
```
!!! warning "Для корректного завершения работы макроса управления iHeater необходимо добавить в завершающий g-code принтера команду iHEATER_OFF"

```
; --- Начало завершающего g-code ---

; ****** Старт блока iHeater ******
iHEATER_OFF
; ****** Конец блока iHeater ******

; --- Остальной завершающий g-code ---
...
```
## Отключение

Для отключения iHeater в файле printer.cfg нужно закомментировать строку [include iHeater.cfg]
```
# [include iHeater.cfg]
```

И удалить из стартового и завершающего g-code соответствующе строки

## Примечания
- Безопасность:

    - Убедитесь, что все подключения выполнены правильно и безопасно.
    - Проверьте, что значения min_temp и max_temp соответствуют спецификациям оборудования.

- Проверка оборудования:
    - Перед использованием протестируйте работу нагревателя и вентилятора.
    - Следите за температурой во время первых запусков.
- Настройка PID:
    - При необходимости выполните калибровку PID для точного контроля температуры.